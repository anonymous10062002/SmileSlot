const token = sessionStorage.getItem("token");
const refreshButton = document.querySelector(".fa-arrows-rotate");
const wrongOtpMsg = document.querySelector(".wrong-otp-msg");   
const randomOTP = document.querySelector(".show-random-otp");
randomOTP.innerText=`9746`;
const inputNumber = document.querySelector("#otp");

const fetchCity = async () => {
  let res = await fetch("http://localhost:4000/users/allcities", {
    method:"GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    }
  });
  let cityData = await res.json();
  const citySelect = document.querySelector("#city");
  cityData.map((city)=>{
    citySelect.innerHTML = `
    <option value="">Select City</option>
    <option value="${city}">${city}</option>
    `
  });
  citySelect.addEventListener("change", () => {
    fetchClinic("Delhi");
  })

  const fetchClinic = async (city) => {
    const response = await fetch(`http://localhost:4000/users/clinic/${city}`, {
      method: "GET",
      headers: {
        "Content-Type":"application/json",
        Authorization: `Bearer ${token}`
      }
    });
    const clinicData = await response.json();
    console.log(clinicData);  
    const clinicSelect = document.querySelector("#clinic");
    clinicData.map((clinic)=>{
      clinicSelect.innerHTML = `
      <option value="">Select Clinic</option>
      <option value="${clinic.clinic}">${clinic.clinic}</option>
    `
    });
    clinicSelect.addEventListener("change", () => {
      showClinicCityData(city, clinicSelect.value);
    });
    
  }

}
window.onload = fetchCity();

refreshButton.addEventListener("click", ()=>{
  generateRandomOTP();
})

const generateRandomOTP = () => {
  var seq = (Math.floor(Math.random() * 10000) + 10000).toString().substring(1);
  randomOTP.innerHTML = `
  <h3>${seq}</h3>
  `
}


const showClinicCityData = (city, clinic) => {
  const showClinicCity = document.querySelector(".show-city-clinic");
    showClinicCity.innerHTML = `
    <i class=" fa-solid fa-location-dot"></i>
    <h3>City: ${city}</h3>
    <h3>Clinic: ${clinic}</h3>
    `;
    showClinicCity.setAttribute("class", "show-clinic-bg")
}

const appointmentForm = document.querySelector("form");
appointmentForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const month = document.querySelector("#month").value;
  const date = document.querySelector("#datee").value;
  const year = document.querySelector("#year").value;
  const exact_date = year+":"+month+":"+date;
  const userDetails = {
    city: document.querySelector("#city").value,
    clinic: document.querySelector("#clinic").value,
    date: exact_date,
    mobile_number: document.querySelector("#mobile-number").value,
    name: document.querySelector("#name").value,
    email: document.querySelector("#email").value,
    text_msg: document.querySelector("#text-message").value,
  };

  appointmentData(
    userDetails.city,
    userDetails.clinic,
    userDetails.date,
    userDetails.mobile_number,
    userDetails.name,
    userDetails.email,
    userDetails.text_msg
  );
});

const appointmentData = async (
  city,
  clinic,
  date
) => {
  const validateOtp = () => {
    const randomNumber = randomOTP.innerText;
    const randomNum = +randomNumber;
    if(randomNum !== inputNumber.value){
      wrongOtpMsg.innerHTML = `
      <p class='red-msg'>Invalid Captcha ! Please refresh and try again</p>
      `
      return;
    }
  }
  validateOtp();
  const appointData = {city,clinic,date}
  const response = await fetch("http://localhost:4000/users/bookslot", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify(appointData)
  })
  console.log(response);
  if(response.status){
    alert("Slot Booked");
  }
  console.log(city, clinic, date);
};